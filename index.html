<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Controle de Acertos</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: #f0f2f5;
    }
    .login, .app {
      max-width: 900px;
      margin: 40px auto;
      padding: 20px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    h2 {
      text-align: center;
    }
    label {
      display: block;
      margin-top: 10px;
      font-weight: bold;
    }
    input, select, button, textarea {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
      border: 1px solid #ccc;
      border-radius: 6px;
      box-sizing: border-box;
    }
    .btn {
      margin-top: 15px;
      background-color: #2e8b57;
      color: white;
      font-weight: bold;
      border: none;
      cursor: pointer;
    }
    .btn:hover {
      background-color: #246b45;
    }
    .hidden {
      display: none;
    }
    .flex { display: flex; gap: 10px; flex-wrap: wrap; }
    .row { margin-top: 10px; }
    .icon-eye {
      position: absolute;
      right: 15px;
      top: 50%;
      transform: translateY(-50%);
      cursor: pointer;
    }
    .senha-container {
      position: relative;
    }
    .sobra-negativa { color: red; }
    .sobra-positiva { color: green; }
    table {
      width: 100%;
      margin-top: 10px;
      border-collapse: collapse;
      table-layout: auto;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 5px;
      text-align: center;
      word-wrap: break-word;
    }
    th { background-color: #eee; }
    .total-box {
      display: flex;
      justify-content: space-between;
      margin-top: 10px;
      font-weight: bold;
    }
    .icon-trash {
      color: red;
      cursor: pointer;
    }
    .icon-edit {
      color: blue;
      cursor: pointer;
    }
  </style>
<!-- TELA DE LOGIN -->
<div class="login" id="loginBox">
  <h2>Login</h2>
  <label>Usu√°rio:</label>
  <input type="text" id="loginUser" placeholder="" autocomplete="off" />
  
  <label>Senha:</label>
  <div class="senha-container">
    <input type="password" id="loginPass" placeholder="" autocomplete="new-password" />
    <i class="fa fa-eye icon-eye" onclick="toggleSenha()"></i>
  </div>
  
  <button class="btn" onclick="fazerLogin()">Entrar</button>
  <p id="loginErro" style="color:red; display:none;">Usu√°rio ou senha inv√°lidos.</p>
</div>

<!-- IN√çCIO DA APLICA√á√ÉO -->
<div class="app hidden" id="appBox">
  <h2>Controle de Acertos</h2>

  <!-- Dados principais -->
  <div class="flex">
    <div class="row" style="flex:1">
      <label>Data:</label>
      <input type="date" id="data" />
    </div>
    <div class="row" style="flex:1">
      <label>Motorista:</label>
      <input type="text" id="motorista" />
    </div>
    <div class="row" style="flex:1">
      <label>Caminh√£o:</label>
      <input type="text" id="caminhao" />
    </div>
  </div>

  <!-- Comiss√£o e pagamento -->
  <div class="flex">
    <div class="row" style="flex:1">
      <label>Comiss√£o R$:</label>
      <input type="number" id="comissao" />
    </div>
    <div class="row" style="flex:1">
      <label>Forma de Pagamento:</label>
      <select id="forma_pagamento">
        <option value="Dinheiro">Dinheiro</option>
        <option value="PIX">PIX</option>
        <option value="Transfer√™ncia">Transfer√™ncia</option>
      </select>
    </div>
  </div>

  <!-- Observa√ß√µes -->
  <div class="row">
    <label>Observa√ß√µes:</label>
    <textarea id="observacao"></textarea>
  </div>
  <!-- Despesas -->
  <div class="row">
    <label>Despesa:</label>
    <div class="flex">
      <input type="text" id="descDespesa" placeholder="Descri√ß√£o" />
      <input type="number" id="valorDespesa" placeholder="Valor" />
      <button class="btn" onclick="adicionarDespesa()">Adicionar</button>
    </div>
    <ul id="listaDespesas"></ul>
  </div>

  <!-- Bot√£o Salvar -->
  <button class="btn" onclick="salvarAcerto()">Salvar Acerto</button>
</div>
<script>
  // Exibir ou ocultar senha
  function toggleSenha() {
    const passInput = document.getElementById("loginPass");
    passInput.type = passInput.type === "password" ? "text" : "password";
  }

  // Verifica login
  function fazerLogin() {
    const u = document.getElementById("loginUser").value.trim();
    const s = document.getElementById("loginPass").value.trim();
    if (u === "master" && s === "123mudar") {
      document.getElementById("loginBox").classList.add("hidden");
      document.getElementById("appBox").classList.remove("hidden");
    } else {
      document.getElementById("loginErro").style.display = "block";
    }
  }

  // Array tempor√°rio para despesas
  let despesasTemp = [];

  // Adiciona nova despesa
  function adicionarDespesa() {
    const desc = document.getElementById("descDespesa").value.trim();
    const valor = parseFloat(document.getElementById("valorDespesa").value);
    if (!desc || isNaN(valor)) return alert("Preencha os campos corretamente.");
    despesasTemp.push({ descricao: desc, valor });
    atualizarListaDespesas();
    document.getElementById("descDespesa").value = "";
    document.getElementById("valorDespesa").value = "";
  }

  // Mostra lista de despesas na tela
  function atualizarListaDespesas() {
    const ul = document.getElementById("listaDespesas");
    ul.innerHTML = "";
    despesasTemp.forEach(d => {
      const li = document.createElement("li");
      li.innerText = `${d.descricao} - R$ ${d.valor.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;
      ul.appendChild(li);
    });
  }

  // Salva acerto no Firebase
  function salvarAcerto() {
    const acerto = {
      data: document.getElementById("data").value,
      motorista: document.getElementById("motorista").value,
      caminhao: document.getElementById("caminhao").value,
      comissao: parseFloat(document.getElementById("comissao").value || 0),
      forma_pagamento: document.getElementById("forma_pagamento").value,
      observacao: document.getElementById("observacao").value,
      despesas: despesasTemp,
      criado_em: new Date().toISOString()
    };
    db.collection("acertos").add(acerto).then(() => {
      alert("Acerto salvo!");
      despesasTemp = [];
      atualizarListaDespesas();
      document.querySelectorAll("#appBox input, #appBox textarea").forEach(el => el.value = "");
    });
  }
</script>
<!-- FILTRO -->
<div class="row">
  <h3>Relat√≥rio de Acertos</h3>
  <div class="flex">
    <div style="flex:1">
      <label>Motorista:</label>
      <input type="text" id="filtroMotorista" />
    </div>
    <div style="flex:1">
      <label>Data Inicial:</label>
      <input type="date" id="filtroInicio" />
    </div>
    <div style="flex:1">
      <label>Data Final:</label>
      <input type="date" id="filtroFim" />
    </div>
    <button class="btn" onclick="listarAcertos()">Ver</button>
    <button class="btn" onclick="gerarPDFComFiltro()">PDF</button>
  </div>
</div>

<!-- TABELA -->
<table>
  <thead>
    <tr>
      <th>Data</th>
      <th>Motorista</th>
      <th>Caminh√£o</th>
      <th>Comiss√£o</th>
      <th>Despesas</th>
      <th>Sobra</th>
      <th>Ver Desp.</th>
      <th>A√ß√µes</th>
    </tr>
  </thead>
  <tbody id="tabelaAcertos"></tbody>
</table>

<!-- TOTAIS -->
<div class="total-box" id="totaisBox">
  <span id="somaDespesas">Total Despesas: R$ 0,00</span>
  <span id="somaSobra">Total Sobra: R$ 0,00</span>
</div>

<script>
  let acertosFiltrados = [];

  function listarAcertos() {
    const filtroMot = document.getElementById("filtroMotorista").value.toLowerCase();
    const inicio = document.getElementById("filtroInicio").value;
    const fim = document.getElementById("filtroFim").value;

    db.collection("acertos").get().then(snapshot => {
      const tbody = document.getElementById("tabelaAcertos");
      tbody.innerHTML = "";
      acertosFiltrados = [];

      let totalDespesas = 0, totalSobra = 0;

      snapshot.forEach(doc => {
        const a = doc.data();
        const id = doc.id;

        // FILTROS
        if (filtroMot && !a.motorista.toLowerCase().includes(filtroMot)) return;
        if (inicio && a.data < inicio) return;
        if (fim && a.data > fim) return;

        const despesas = a.despesas || [];
        const somaDespesas = despesas.reduce((t, d) => t + d.valor, 0);
        const sobra = a.comissao - somaDespesas;

        totalDespesas += somaDespesas;
        totalSobra += sobra;

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${a.data}</td>
          <td>${a.motorista}</td>
          <td>${a.caminhao}</td>
          <td>R$ ${a.comissao.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
          <td>R$ ${somaDespesas.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
          <td class="${sobra < 0 ? 'sobra-negativa' : 'sobra-positiva'}">
            R$ ${sobra.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}
          </td>
          <td><button onclick="alert('${despesas.map(d => d.descricao + ': R$ ' + d.valor.toFixed(2)).join('\\n') || 'Sem despesas'}')">üëÅÔ∏è</button></td>
          <td>
            <i class="fa fa-edit icon-edit" onclick="editarAcerto('${id}')"></i>
            <i class="fa fa-trash icon-trash" onclick="excluirAcerto('${id}')"></i>
          </td>
        `;
        tbody.appendChild(tr);
        acertosFiltrados.push({ id, ...a, sobra, totalDespesas: somaDespesas });
      });

      document.getElementById("somaDespesas").innerText = `Total Despesas: R$ ${totalDespesas.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;
      document.getElementById("somaSobra").innerText = `Total Sobra: R$ ${totalSobra.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;
    });
  }

  function excluirAcerto(id) {
    if (confirm("Deseja excluir este acerto?")) {
      db.collection("acertos").doc(id).delete().then(() => {
        listarAcertos();
      });
    }
  }

  function editarAcerto(id) {
    db.collection("acertos").doc(id).get().then(doc => {
      const a = doc.data();
      document.getElementById("data").value = a.data;
      document.getElementById("motorista").value = a.motorista;
      document.getElementById("caminhao").value = a.caminhao;
      document.getElementById("comissao").value = a.comissao;
      document.getElementById("forma_pagamento").value = a.forma_pagamento;
      document.getElementById("observacao").value = a.observacao;
      despesasTemp = a.despesas || [];
      atualizarListaDespesas();

      // Remove e regrava
      db.collection("acertos").doc(id).delete();
    });
  }

  async function gerarPDFComFiltro() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    doc.setFontSize(14);
    doc.text("Relat√≥rio de Acertos", 105, 15, { align: "center" });
    let y = 30;

    acertosFiltrados.forEach((a, i) => {
      if (y > 270) {
        doc.addPage();
        y = 20;
      }
      doc.setFontSize(11);
      doc.text(`${a.data} | ${a.motorista} | ${a.caminhao} | Comiss√£o: R$ ${a.comissao.toFixed(2)} | Despesas: R$ ${a.totalDespesas.toFixed(2)} | Sobra: R$ ${a.sobra.toFixed(2)}`, 10, y);
      y += 10;
    });

    doc.save("relatorio_acertos.pdf");
  }
</script>
@media (max-width: 768px) {
  .flex {
    flex-direction: column;
  }
  table {
    font-size: 12px;
  }
  .total-box {
    flex-direction: column;
    align-items: flex-start;
  }
}

</head>
<body>
